name: Run PHP Extension Tests
description: Common steps for running PHP extension tests with Valkey servers

inputs:
  extension-path:
    description: Path to the built extension (.so file)
    required: true
  php-version:
    description: PHP version to use for testing
    required: true
    default: "8.1"

runs:
  using: composite
  steps:
    - name: Start Valkey servers
      working-directory: tests
      shell: bash
      run: |
        set -e  # Exit on any error

        # Ensure /usr/local/bin is in PATH (where valkey-server is installed)
        export PATH="/usr/local/bin:$PATH"

        echo "=== DEBUG: Current directory and files ==="
        pwd
        ls -la

        echo "=== DEBUG: Environment ==="
        echo "PATH=$PATH"

        echo "=== DEBUG: Checking for installed binaries in /usr/local/bin ==="
        ls -la /usr/local/bin/ | grep -E "(valkey|redis)" || echo "No valkey/redis binaries in /usr/local/bin"

        echo "=== DEBUG: Checking script permissions ==="
        ls -la start_valkey_with_replicas.sh create-valkey-cluster.sh

        # Make scripts executable
        chmod +x start_valkey_with_replicas.sh create-valkey-cluster.sh

        echo "=== DEBUG: After chmod ==="
        ls -la start_valkey_with_replicas.sh create-valkey-cluster.sh

        # Check if valkey-server is available
        echo "=== DEBUG: Checking for valkey-server ==="
        which valkey-server || echo "valkey-server not found in PATH"

        # Check alternative locations and names
        echo "=== DEBUG: Checking alternative binary names ==="
        which redis-server || echo "redis-server not found in PATH"
        which valkey-cli || echo "valkey-cli not found in PATH"
        which redis-cli || echo "redis-cli not found in PATH"

        # Start standalone servers (6379, 6380, 6381)
        echo "=== Starting standalone Valkey servers ==="
        ./start_valkey_with_replicas.sh

        # Wait a moment for servers to start
        echo "=== Waiting for standalone servers to start ==="
        sleep 3

        # Check if servers are running
        echo "=== Checking standalone server status ==="
        ps aux | grep -E "(valkey|redis)-server" | grep -v grep || echo "No valkey/redis-server processes found"

        # Start cluster servers (7001-7006)
        echo "=== Starting Valkey cluster ==="
        ./create-valkey-cluster.sh

        # Final server status check
        echo "=== Final server status check ==="
        ps aux | grep -E "(valkey|redis)-server" | grep -v grep || echo "No valkey/redis-server processes found"
        echo "=== Valkey servers startup completed ==="

    - name: Run PHP extension tests
      shell: bash
      env:
        EXTENSION_PATH: ${{ inputs.extension-path }}
      run: |
        # Debug: Check if extension is loaded and classes exist
        echo "=== Extension Debug Info ==="
        echo "Extension path: $EXTENSION_PATH"

        php -n -d "extension=$EXTENSION_PATH" -r "
          echo 'Extension loaded: ' . (extension_loaded('valkey_glide') ? 'YES' : 'NO') . PHP_EOL;
          echo 'Extension version: ' . phpversion('valkey_glide') . PHP_EOL;
          echo 'Extension functions: ' . PHP_EOL;
          foreach (get_extension_funcs('valkey_glide') as \$func) {
            echo '  - ' . \$func . PHP_EOL;
          }
          echo 'All declared classes: ' . PHP_EOL;
          foreach (get_declared_classes() as \$class) {
            if (strpos(\$class, 'Valkey') !== false || strpos(\$class, 'Client') !== false || strpos(\$class, 'Mock') !== false) {
              echo '  - ' . \$class . PHP_EOL;
            }
          }
          echo 'ClientConstructorMock exists: ' . (class_exists('ClientConstructorMock') ? 'YES' : 'NO') . PHP_EOL;
          if (class_exists('ClientConstructorMock')) {
            echo 'ClientConstructorMock methods: ' . PHP_EOL;
            foreach (get_class_methods('ClientConstructorMock') as \$method) {
              echo '  - ' . \$method . PHP_EOL;
            }
          }
        "

        # Run tests using extension loading
        php -n -d "extension=$EXTENSION_PATH" tests/TestValkeyGlide.php

    - name: Run integration tests
      shell: bash
      run: |
        # All tests are now run through the main TestValkeyGlide.php runner
        echo "All 4 test classes are already included in the main test runner"
        echo "TestValkeyGlide.php now runs all classes by default:"
        echo "- ValkeyGlide_Test (standalone)"
        echo "- ValkeyGlide_Cluster_Test (cluster)"
        echo "- ValkeyGlide_Features_Test (standalone features)"
        echo "- ValkeyGlide_Cluster_Features_Test (cluster features)"

    - name: Stop Valkey servers
      if: always()
      shell: bash
      run: |
        # Stop all Valkey server processes
        echo "Stopping Valkey servers..."
        pkill valkey-server || true
        # Clean up data directories
        rm -rf $HOME/valkey-cluster || true
        rm -rf tests/valkey_data || true
